apiVersion: v1
kind: Namespace
metadata:
  name: demo
---
# ========== ZOOKEEPER ==========
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zookeeper
  namespace: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: zookeeper
  template:
    metadata:
      labels:
        app: zookeeper
    spec:
      containers:
        - name: zookeeper
          image: confluentinc/cp-zookeeper:7.6.1
          ports:
            - containerPort: 2181
          env:
            - name: ZOOKEEPER_CLIENT_PORT
              value: '2181'
            - name: ZOOKEEPER_TICK_TIME
              value: '2000'
---
apiVersion: v1
kind: Service
metadata:
  name: zookeeper
  namespace: demo
spec:
  selector:
    app: zookeeper
  ports:
    - name: client
      port: 2181
      targetPort: 2181
---
# ========== KAFKA ==========
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kafka
  namespace: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kafka
  template:
    metadata:
      labels:
        app: kafka
    spec:
      enableServiceLinks: false
      initContainers:
        - name: wait-for-zookeeper
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for Zookeeper at zookeeper:2181..."
              until nc -z zookeeper 2181; do
                sleep 2
              done
              echo "Zookeeper is up, waiting additional 5s..."
              sleep 5
              echo "Starting Kafka"
      securityContext:
        fsGroup: 1000
      containers:
        - name: kafka
          image: confluentinc/cp-kafka:7.6.1
          ports:
            - containerPort: 29092
          env:
            - name: KAFKA_BROKER_ID
              value: '1'
            - name: KAFKA_ZOOKEEPER_CONNECT
              value: 'zookeeper:2181'

            - name: KAFKA_LISTENERS
              value: 'PLAINTEXT://0.0.0.0:29092'
            - name: KAFKA_ADVERTISED_LISTENERS
              value: 'PLAINTEXT://kafka:29092'
            - name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP
              value: 'PLAINTEXT:PLAINTEXT'
            - name: KAFKA_INTER_BROKER_LISTENER_NAME
              value: 'PLAINTEXT'

            - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
              value: '1'
            - name: KAFKA_AUTO_CREATE_TOPICS_ENABLE
              value: 'true'

            - name: KAFKA_LOG_DIRS
              value: '/var/lib/kafka/data'
            - name: KAFKA_HEAP_OPTS
              value: '-Xms512m -Xmx1024m'

            # Additional stability settings
            - name: KAFKA_LOG4J_ROOT_LOGLEVEL
              value: 'INFO'
            - name: KAFKA_TOOLS_LOG4J_LOGLEVEL
              value: 'ERROR'

          volumeMounts:
            - name: kafka-data
              mountPath: /var/lib/kafka/data

          # Add startup probe to give Kafka more time to initialize
          startupProbe:
            tcpSocket:
              port: 29092
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 30

          # Add liveness probe
          livenessProbe:
            tcpSocket:
              port: 29092
            initialDelaySeconds: 30
            periodSeconds: 10
            failureThreshold: 3

          # Add readiness probe
          readinessProbe:
            tcpSocket:
              port: 29092
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 3

          resources:
            requests:
              cpu: '500m'
              memory: '1.5Gi'
            limits:
              cpu: '2'
              memory: '2Gi'
      volumes:
        - name: kafka-data
          emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: kafka
  namespace: demo
spec:
  selector:
    app: kafka
  ports:
    - name: broker
      port: 29092
      targetPort: 29092
---
# ========== SERVER ==========
apiVersion: apps/v1
kind: Deployment
metadata:
  name: server
  namespace: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: server
  template:
    metadata:
      labels:
        app: server
    spec:
      initContainers:
        - name: wait-for-kafka
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for Kafka at kafka:29092..."
              until nc -z kafka 29092; do
                sleep 2
              done
              echo "Kafka is up, starting server"
      containers:
        - name: server
          image: demo-server:1
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          env:
            - name: PORT
              value: '8080'
            - name: KAFKA_BROKER
              value: 'kafka:29092'
            - name: KAFKA_TOPIC
              value: 'button-events'

---
apiVersion: v1
kind: Service
metadata:
  name: server
  namespace: demo
spec:
  selector:
    app: server
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  type: ClusterIP
---
# ========== CONSUMER ==========
apiVersion: apps/v1
kind: Deployment
metadata:
  name: consumer
  namespace: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: consumer
  template:
    metadata:
      labels:
        app: consumer
    spec:
      initContainers:
        - name: wait-for-kafka
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for Kafka at kafka:29092..."
              until nc -z kafka 29092; do
                sleep 2
              done
              echo "Kafka is up, starting consumer"
      containers:
        - name: consumer
          image: demo-consumer:1
          imagePullPolicy: IfNotPresent
          env:
            - name: KAFKA_BROKER
              value: 'kafka:29092'
            - name: KAFKA_TOPIC
              value: 'button-events'
            - name: KAFKA_GROUP_ID
              value: 'demo-consumer-group'

---
# ========== CLIENT (Nginx proxy /api -> server) ==========
apiVersion: v1
kind: ConfigMap
metadata:
  name: client-nginx-conf
  namespace: demo
data:
  default.conf: |
    server {
      listen 80;
      server_name _;

      root /usr/share/nginx/html;
      index index.html;

      location / {
        try_files $uri $uri/ /index.html;
      }

      
      location /api/ {
        proxy_pass http://server:8080;
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: client
  namespace: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: client
  template:
    metadata:
      labels:
        app: client
    spec:
      containers:
        - name: client
          image: demo-client:1
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 80
          volumeMounts:
            - name: nginx-conf
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
      volumes:
        - name: nginx-conf
          configMap:
            name: client-nginx-conf
---
apiVersion: v1
kind: Service
metadata:
  name: client
  namespace: demo
spec:
  selector:
    app: client
  ports:
    - name: http
      port: 80
      targetPort: 80
  type: NodePort
